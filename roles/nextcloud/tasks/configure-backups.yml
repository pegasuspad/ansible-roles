# - name: Install backup and restore scripts
#   ansible.builtin.copy:
#     src: "{{ item }}"
#     dest: /usr/local/bin
#     owner: root
#     group: root
#     mode: "0744"
#   with_fileglob:
#     - "usr/local/bin/*"

# - name: Perform nightly backups
#   become: true
#   ansible.builtin.cron:
#     hour: "7" # 2am central
#     job: /usr/local/bin/cronjob-lock /usr/local/bin/backup >>{{ nextcloud_logfile }} 2>&1
#     minute: "2"
#     name: "backup nextcloud nightly"
#     state: present
#     user: "root"

- name: (BACKUP) Install and configure restic
  ansible.builtin.include_role:
    name: local.pegasuspad.restic
  vars:
    restic_backups:
      - name: '{{ __nextcloud_backup.name }}'
        niceness: 10
        pre_backup_cmd: '{{ __nextcloud_backup.script_dir }}/stage-backup'
        repo: aws
        scheduled: false
        src: '{{ __nextcloud_paths.backup_temp }}'
        tags:
          - v{{ nextcloud_version }}
    restic_dir_group: '{{ __nextcloud_backup.group }}'
    restic_dir_owner: '{{ __nextcloud_backup.user }}'
    restic_download_path: '{{ __nextcloud_backup.script_dir }}'
    restic_no_log: true
    restic_repos:
      aws: # actually B2
        aws_access_key: '{{ __nextcloud_backup.repository.b2_access_key_id }}'
        aws_secret_access_key: '{{ __nextcloud_backup.repository.b2_access_key_secret }}'
        location: '{{ nextcloud_backup_repository.url }}'
        password: '{{ __nextcloud_backup.repository.password }}'
        init: false
    restic_script_dir: '{{ __nextcloud_backup.script_dir }}'

- name: (BACKUP) Install backup scripts
  ansible.builtin.template:
    src: "{{ item }}"
    dest: '{{ __nextcloud_backup.script_dir }}'
    owner: root
    group: root
    # these files contain credentials, so only allow root to read them
    mode: "0700"
  with_fileglob:
    - "../templates/[__nextcloud_backup.script_dir]/*"