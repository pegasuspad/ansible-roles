#!/usr/bin/env bash

set -e

backupDirectory="{{ __nextcloud_paths.backup_temp }}/staging"
occPath="{{ __nextcloud_current_version_path }}/occ"
sourceDirectory="{{ __nextcloud_paths.data }}"

# Remove existing staging directory
rm -rf "${backupDirectory}"

# Recreate staging data directory
mkdir -p "${backupDirectory}/data"

# Create unsafe staged backup, which will be resynced during maintenance mode
rsync -az --delete "${sourceDirectory}/" "${backupDirectory}/data"

# Finalize staged backup with any changes made during initial sync
# Enable maintenance mode
sudo -u www-data php "${occPath}" maintenance:mode --on

# Resync files to staging area
rsync -az --delete "${sourceDirectory}/" "${backupDirectory}/data"

# Create database backup